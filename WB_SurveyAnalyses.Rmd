---
title: "MA-DMF West Beach Survey Data"
author: "Forest Schenck"
date: "November 07, 2017"
output: pdf_document
---

#Packages etc...
```{r}
rm(list = ls())

library(dplyr)
library(sciplot)
library(ggplot2)
library(tidyr)
library(vegan)

library(lme4)
library(car)

source("http://faraway.neu.edu/data/Rprofile")

#time series data
library(lubridate)

```

#Uploading Data
```{r}
wb <- read.csv("WB_surveydata.csv", header = T)

str(wb)

wb.5shoot.binom <- read.csv("WastingDiseasePA_31OCT2017.csv", header = T)
```

#Data Vizualization
##5-shoot data
###Shallow vs. Deep
```{r}
#wb.depth <- filter(wb, depth != "mid")

#bargraph.CI(x.factor = depth, response = wd.prevalence, main = "5-shoot Prevalence", data = wb.depth, ylim = c(0,1.1), ylab = "proportion of shoots infected per plot")


```

###July vs. October (split by deep and shallow)
```{r}
#prevalence (presence vs absence)
bargraph.CI(x.factor = depth,
            response = wb.5shoot.binom.ds$wd.present/(wb.5shoot.binom.ds$wd.present+wb.5shoot.binom.ds$wd.absent),
            #group = month.collected,
            data = wb.5shoot.binom.ds,
            ylim = c(0,1.1),
            col = c(cb["grey"], cb["white"]))
            #main = "5-shoot Prevalence",
            #ylab = "proportion of shoots infected per plot", legend = T)

#various lesion severity levels
##trace
#wb.depth$WD.field.est.trace.p <- wb.depth$WD.field.est.trace / (wb.depth$WD.field.est.absent + wb.depth$WD.field.est.trace + wb.depth$WD.field.est.low + wb.depth$WD.field.est.mid + wb.depth$WD.field.est.high)

#bargraph.CI(x.factor = month.collected, response = WD.field.est.trace.p, group = depth, data = wb.depth, ylim = c(0,1.1), main = "5-shoot Trace", ylab = "proportion of shoots with 1% lesion cover per plot", legend = T)

##low
#wb.depth$WD.field.est.low.p <- wb.depth$WD.field.est.low / (wb.depth$WD.field.est.absent + wb.depth$WD.field.est.trace + wb.depth$WD.field.est.low + wb.depth$WD.field.est.mid + wb.depth$WD.field.est.high)

#bargraph.CI(x.factor = month.collected, response = WD.field.est.low.p, group = depth, data = wb.depth, ylim = c(0,1.1), main = "5-shoot Low", ylab = "proportion of shoots with 2-10% lesion cover per plot", legend = T)

##mid
#wb.depth$WD.field.est.mid.p <- wb.depth$WD.field.est.mid / (wb.depth$WD.field.est.absent + wb.depth$WD.field.est.trace + wb.depth$WD.field.est.low + wb.depth$WD.field.est.mid + wb.depth$WD.field.est.high)

#bargraph.CI(x.factor = month.collected, response = WD.field.est.mid.p, group = depth, data = wb.depth, ylim = c(0,1.1), main = "5-shoot Mid", ylab = "proportion of shoots with 11-30% lesion cover per plot", legend = T)

##high - No high infections observed

## plotting prevalence by month and depth and split by infection severity

#wb.depth.long <- gather(wb.depth, lesion.cover, no.samples, WD.field.est.absent:WD.field.est.high) #makes rows for each lesion.cover category

#wb.depth.long2 <- wb.depth.long %>%
  #group_by(month.collected, depth, quadrat.id) %>%
  #summarize(no.samples.total = sum(no.samples, na.rm = T)) #calculating samples per quadrat

#wb.depth.long <- merge(wb.depth.long, wb.depth.long2, by = c("month.collected", "depth", "quadrat.id")) #adding samples per quadrat into dataframe

#wb.depth.long$no.sample.prop <- wb.depth.long$no.samples/wb.depth.long$no.samples.total

#wb.depth.long.plot <- wb.depth.long %>%
  #group_by(month.collected, depth, lesion.cover) %>%
  #summarize(no.samples.prop = mean(no.sample.prop, na.rm = T), sd.prop = sd(no.sample.prop, na.rm = T)) #depth by month averages for each lesion cover type

#str(wb.depth.long.plot)

#ordering lesion.cover factor
#wb.depth.long.plot$lesion.cover <-as.factor(wb.depth.long.plot$lesion.cover)
#print(levels(wb.depth.long.plot$lesion.cover))
#wb.depth.long.plot$lesion.cover <- factor(wb.depth.long.plot$lesion.cover, levels(wb.depth.long.plot$lesion.cover)[c(1, 5, 3, 4, 2)])

#ggplot(data = wb.depth.long.plot, aes(x = depth, y = no.samples.prop, fill = lesion.cover)) +
  #geom_bar(stat = "identity", colour = "black") +
  #facet_grid(~month.collected) +
  #scale_fill_manual(values = c("white", "yellow", "orange", "red", "purple")) +
  #labs(title = "Lesion Prevalence by collection month, transect depth and lesion % cover", x = "", y = "Mean proportion of samples with lesions per plot", fill = "Lesion % cover") +
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour ="black"))

###Lesion prevalence analyses
wb.5shoot.binom$wd.absent <- 1 - wb.5shoot.binom$wd.present

wb.5shoot.binom.ds <- wb.5shoot.binom %>%
  filter(depth != 'mid') %>%
  group_by(year.collected, month.collected, depth, quadrat.id) %>%
  summarize(zm.veg.density = mean(zm.veg.density, na.rm = T), canopy.height = mean(canopy.height, na.rm = T), wd.present = sum(wd.present, na.rm = T), wd.absent = sum(wd.absent, na.rm = T))


##binom model
model <- glm(cbind(wd.present, wd.absent) ~ month.collected*depth, na.action = na.omit, data = wb.5shoot.binom.ds, family = binomial) #glmer ... + (1|month.collected/depth/quadrat.id)
Anova(model)
anova(model, test = "LR") ### add quadrat as a random effect give each quadrat a unique identifier I don't think I need to because coded as quadrats not individual shoots

model <- lm(zm.veg.density ~ month.collected * depth, na.action = na.omit, data = wb.5shoot.binom.ds) #density analyses
anova(model) #depth not month significant

##analyzing proportion of samples in anova.
model <- lm(wd.prevalence ~ depth * month.collected + month.collected/depth/quadrat.id, data = wb)
anova(model)
```

###NMDS 5-shoot
```{r}
###DATA ORGANIZATION
wb.nmds <- wb[!is.na(wb$WD.field.est.absent) & 
                !is.na(wb$WD.field.qual.trace) &
                !is.na(wb$WD.field.est.low) &
                !is.na(wb$WD.field.est.mid) &
                !is.na(wb$zm.veg.density0.0625m2) &
                !is.na(wb$canopy.height.cm) &
                wb$depth != "mid", ]
  #group_by(month.collected, depth) %>%
  #summarize(WD.field.est.absent = sum(WD.field.est.absent), WD.field.est.trace = sum(WD.field.est.trace), WD.field.est.low = sum(WD.field.est.low), WD.field.est.mid = sum(WD.field.est.mid))

#wb.nmds$WD.field.est.absent.p <- 1-wb.nmds$wd.prevalence

wb.nmds$WD.field.est.trace.p <- wb.nmds$WD.field.est.trace / (wb.nmds$WD.field.est.trace + wb.nmds$WD.field.est.low + wb.nmds$WD.field.est.mid) #wb.nmds$WD.field.est.absent + wb.nmds$WD.field.est.high

wb.nmds$WD.field.est.low.p <- wb.nmds$WD.field.est.low / (wb.nmds$WD.field.est.trace + wb.nmds$WD.field.est.low + wb.nmds$WD.field.est.mid) #wb.nmds$WD.field.est.absent + wb.nmds$WD.field.est.high

wb.nmds$WD.field.est.mid.p <- wb.nmds$WD.field.est.mid / (wb.nmds$WD.field.est.trace + wb.nmds$WD.field.est.low + wb.nmds$WD.field.est.mid) # wb.nmds$WD.field.est.absent + wb.nmds$WD.field.est.high

wb.nmds$month.depth <- paste(wb.nmds$month.collected, wb.nmds$depth, sep = ".")

wb.nmds$month.depth <- as.factor(wb.nmds$month.depth)

community <- subset(wb.nmds, select = c( #"WD.field.est.absent.p",
                                        "WD.field.est.trace.p",
                                        "WD.field.est.low.p",
                                        "WD.field.est.mid.p"))


str(wb.nmds)

## --- nMDS Analysis/figures ---
set.seed(1)

# Hellinger transformation to downplay the effects of rare species
# community.trans <- decostand(community, "hell")

comm.mds <- metaMDS(community, autotransform = FALSE) ##nMDS analysis code

# Rsquared
(Rsq <- 1 - comm.mds$stress^2) #high Rsquared means that axis explain most of variation in data

# Extract quadrat scores from nMDS object to facilitate custom plot
quad.scores <- comm.mds$points

# Extract disease severity category scores (commonly species scores)
severity.scores <- comm.mds$species

# Relabel severity scores
rownames(severity.scores) <- c(#"Absent",
                               "Trace",
                               "Low",
                               "Mid")

mycols.month <- cb[c("blue", "red")]
mycols.month.depth <- cb[c("blue",  "turquoise", "red" , "orange")] ##setting up vector to color points by depth, data set won't ignore third depth so added extra for 'ghost' mid depth)

## Prepare an empty plot
#pdf(file="nmds_meanMaxTemp.pdf", width=8, height=8)
par(plotconf)
plot(comm.mds$points[ , 1], comm.mds$points[ , 2], t = "n", 
     xlab = "nMDS 1", ylab = "",
     main= "",
     xlim = c(-1.25, 1.25), 
     xaxs = "i",
     ylim = c(-1.25, 1.25))
# Add y-axis label
ylabel("nMDS 2")
# Add top and right axes
mbox()
## Draw grid with dashed lines about origin
abline(h = 0, lty = 2)
abline(v = 0, lty = 2)
add_label(x = 0.78, lab = substitute(paste(R^2 == rsq),
                                     list(rsq = format(Rsq, digit = 5))))

# Plot each region's site scores in a different color and shape
#for (i in 1:length(levels(wb.nmds$month.depth))) {
  #locs <- which(wb.nmds$month.depth == levels(wb.nmds$month.depth)[i])
  #p <- quad.scores[locs, 1:2]
  #points(p[ , 1], p[ , 2], pch = i + 20, 
         #bg = mycols.month.depth[i], 
         #col = mycols.month.depth[i])
#}

#Plot each months site scores by color and shape
points(jitter(quad.scores[1:12,], factor = 1, amount = 0.15), pch = 21, bg = mycols.month[1], col = mycols.month[1], cex = 2)
points(jitter(quad.scores[13:24,], factor = 1, amount = 0.15), pch = 22, bg = mycols.month[2], col = mycols.month[2], cex = 2)


month.depth.names <- paste(levels(wb.nmds$month.depth)) #, "month")
legend(x = "topleft", legend = c("July", "October"), pch = (1:2) + 20, 
       col = mycols.month, 
       pt.bg = mycols.month, cex = 2)
text(severity.scores, rownames(severity.scores), col = cb["yellow"], cex = 2)

regions <- wb.nmds$month.collected
#regions2 <- wb$depth

expl.all <- subset(wb.nmds, select = c("zm.veg.density0.0625m2", 
                                      "canopy.height.cm",
                                      "month.collected",
                                      "depth"))

env <- subset(wb.nmds, select = c("month.collected",
                                  "depth"))

biotic <- subset(wb.nmds, select = c("zm.veg.density0.0625m2", 
                                      "canopy.height.cm"))

expl.fit <- envfit(comm.mds, expl.all, permu = 999, na.rm = TRUE)
env.fit <- envfit(comm.mds, env, permu = 999, na.rm = TRUE)
biotic.fit <- envfit(comm.mds, biotic, permu = 999, na.rm = TRUE)
expl.fit
env.fit
biotic.fit

rownames(expl.fit$factors$centroids) <- c("July", "October" , "" , "")
rownames(expl.fit$vectors$arrows) <- c("Density", "Length")

expl.fit2 <- expl.fit
#expl.fit2$vectors <- NULL

# Plot 95% CI ellipses
plot(expl.fit2, p.max = 0.2, col = cb["black"])
pl <- ordiellipse(comm.mds, regions, kind = "se", conf = 0.95, lwd = 2, 
                  draw = "poly", col = mycols.month, alpha = 40, label = FALSE)

```


###PCA
```{r}
#PCA
###DATA ORGANIZATION
#wb.nmds$WD.field.est.absent.p <- 1-wb.depth$wd.prevalence
#wb.nmds$total.count <- (wb.nmds$WD.field.est.absent + wb.nmds$WD.field.est.trace + wb.depth$WD.field.est.low + wb.depth$WD.field.est.mid + wb.depth$WD.field.est.high)


#wb.pca <- wb.depth %>%
 # filter(total.count != "NA")
#wb.pca <- data.frame(wb.pca$month.collected, wb.pca$depth, wb.pca$WD.field.est.absent, wb.pca$WD.field.est.trace, wb.pca$WD.field.est.low, wb.pca$WD.field.est.mid)

#colnames(wb.pca) <- c("month", "depth", "absent", "trace", "low", "mid")

#PCA.res <- prcomp(wb.pca[,3:6], scale. = T)

#summary(PCA.res) #the proportion of variance explained by each component

##FIG
#par(las =1, mgp = c(2.5, 0.2, 0), mfrow = c(1,1), mar = c(3.75,4,0.5,0.375), tck = 0.01)
#par(oma = c(2, 1, 1, 1))

#screeplot(PCA.res, bstick = TRUE, bst.col = "black", ylab = "Eigenvalue", legend = "", ptype = "points", col = "white", main = "")

#bstick(PCA.res) #broken stick values

#bp.scree <- barplot(height = PCA.res$sdev^2, names.arg = c("PC1", "PC2", "PC3", "PC4"), space = 0.2, col = "white", ylim = c(0,4), ylab = "Eigenvalue")
#points(x = bp.scree, bstick(PCA.res),
     #pch = 1)

#op <- par("usr")

#PCA.res$rotation[,1:4] #how much each factor loads on each PCA
#PCA.res$sdev^2 #eigenvalue

#biplot(PCA.res)

#PCA.plot.data <- data.frame(PCA.res$x[,1:2])
#PCA.res

#pca

#str(wb.pca)

#wb.pca$absent <- as.numeric(wb.pca$absent)
#wb.pca$trace <- as.numeric(wb.pca$trace)
#wb.pca$low <- as.numeric(wb.pca$low)
#wb.pca$mid <- as.numeric(wb.pca$mid)

# pca <- prcomp(wb.pca[,unlist(lapply(wb.pca, FUN=class))=="numeric"])
# plot(PCA.res$x[,1:2], pch=16, col=as.numeric(wb.pca[,"month"]), main="Color annotation") # 2 first principal components
# legend("bottomleft", pch=16, col=unique(as.numeric(wb.pca[,"month"])), legend=unique(wb.pca[,"month"]))
# 
# plot(PCA.res$x[,1:2], pch=16, col=as.numeric(wb.pca[,"depth"]), main="Color annotation") # 2 first principal components
# legend("bottomleft", pch=16, col=unique(as.numeric(wb.pca[,"depth"])), legend=unique(wb.pca[,"depth"]))
# 
# PCA.plot.data$PC1.jitter <- jitter(PCA.plot.data$PC1, 50)
# PCA.plot.data$PC2.jitter <- jitter(PCA.plot.data$PC2, 50)
# 
# plot(PC2.jitter ~ PC1.jitter, pch=as.numeric(wb.pca[,"depth"]), col=as.numeric(wb.pca[,"month"]), main="", xlim=c(-3,3), data = PCA.plot.data) # 2 first principal components
# legend("bottomleft", pch = 18, col=unique(as.numeric(wb.pca[,"month"])), legend=unique(wb.pca[,"month"]))
# legend("bottomright", pch=unique(as.numeric(wb.pca[,"depth"])), legend=unique(wb.pca[,"depth"]))
```

###Prevalence by Canopy Length and shoot density
```{r}
plot(wd.prevalence ~ canopy.height.cm, data = filter(wb, wd.prevalence != "NA"), ylim = c(0,1.1))

plot(wd.prevalence ~ zm.veg.density0.0625m2, data = filter(wb, wd.prevalence != "NA"), ylim = c(0,1.1))

#BINOMIAL PLOTS
##Canopy.height
plot(wb.5shoot.binom$canopy.height, wb.5shoot.binom$wd.present,
     xlab = "Canopy Height (cm)",
     ylab = "Probability of disease")

model <- glm(wd.present ~ canopy.height, family = binomial(link = 'logit'), data = wb.5shoot.binom)#logistic regression
summary(model)

curve(predict(model, data.frame(canopy.height = x), type = "resp"), add = T)

##shoot density
plot(wb.5shoot.binom$zm.veg.density, wb.5shoot.binom$wd.present,
     xlab = "Density (shoots/0.25x0.25m)",
     ylab = "Probability of disease")

model <- glm(wd.present ~ zm.veg.density, family = binomial(link = 'logit'), data = wb.5shoot.binom)#logistic regression
summary(model)

curve(predict(model, data.frame(zm.veg.density = x), type = "resp"), add = T)
```

###Canopy height and density by depth
```{r}
bargraph.CI(x.factor = depth,
            response = zm.veg.density0.0625m2,
            #group = depth,
            data = wb,
            ylim = c(0,30),
            main = "",
            ylab = "Z. marina density 0.0625 m2", legend = T)

bargraph.CI(x.factor = depth,
            response = canopy.height.cm,
            #group = depth,
            data = wb,
            ylim = c(0,150),
            main = "",
            ylab = "Z. marina canopy height cm", legend = T)
bargraph.CI(x.factor = depth,
            response = canopy.height.cm,
            group = month.collected,
            data = wb,
            ylim = c(0,150),
            main = "",
            ylab = "Z. marina canopy height cm", legend = T)

model <-aov(zm.veg.density0.0625m2 ~ depth*month.collected, data = wb)
anova(model)
plot(model)
shapiro.test(model$residuals) #pass
posthoc <- TukeyHSD(x=model, 'depth', conf.level=0.95)
posthoc

model <-aov(canopy.height.cm ~ depth * month.collected, data = wb)
anova(model)
plot(model)
shapiro.test(model$residuals) #fail without transformation
```


##Qualitative plot level

###Shallow vs. Deep
```{r}
bargraph.CI(x.factor = depth, response = 1-WD.field.qual.absent, main = "Qualitative Score", data = wb.depth, ylim = c(0,1.1), ylab = "proportion of plots with infections")
```

###July vs. October (split by deep and shallow)
```{r}
#prevalence (presence vs absence)
bargraph.CI(x.factor = month.collected, response = 1-WD.field.qual.absent, group = depth, data = wb.depth, ylim = c(0,1.1), main = "Qualitative", ylab = "proportion of plots with infections", legend = T)

## plotting prevalence by month and depth and split by infection severity

wb.depth.long.qual <- gather(wb.depth, lesion.cover, no.samples, WD.field.qual.absent:WD.field.qual.low) #makes rows for each lesion.cover category

wb.depth.long.qual.plot <- wb.depth.long.qual %>%
  group_by(month.collected, depth, lesion.cover) %>%
  summarize(no.samples = mean(no.samples, na.rm = T)) #depth by month averages for each lesion cover type

str(wb.depth.long.qual.plot)

#ordering lesion.cover factor
wb.depth.long.qual.plot$lesion.cover <-as.factor(wb.depth.long.qual.plot$lesion.cover)
print(levels(wb.depth.long.qual.plot$lesion.cover))
wb.depth.long.qual.plot$lesion.cover <- factor(wb.depth.long.qual.plot$lesion.cover, levels(wb.depth.long.qual.plot$lesion.cover)[c(1, 3, 2)])

ggplot(data = wb.depth.long.qual.plot, aes(x = depth, y = no.samples, fill = lesion.cover)) +
  geom_bar(stat = "identity", colour = "black") +
  facet_grid(~month.collected) +
  scale_fill_manual(values = c("white", "yellow", "orange")) +
  labs(title = "Qualitative lesion prevalence by collection month, transect depth and lesion % cover",
       x = "", y = "Proportion of plots with lesion severity type", fill = "Lesion % cover") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour ="black"))

###Lesion prevalence analyses
wb.depth$WD.field.qual.present <- 1 - wb.depth$WD.field.qual.absent

model <- glm(cbind(WD.field.qual.present, WD.field.qual.absent) ~ depth * month.collected, na.action = na.omit, data = wb.depth, family = binomial)
anova(model, test = "LR")
```

###Prevalence by Canopy Length and shoot density
```{r}
##Canopy.height
plot(wb.depth$canopy.height, 1-wb.depth$WD.field.qual.absent,
     xlab = "Canopy Height (cm)",
     ylab = "Probability of disease")

model <- glm(1-WD.field.qual.absent ~ canopy.height.cm, family = binomial(link = 'logit'), data = wb.depth)#logistic regression
summary(model)

curve(predict(model, data.frame(canopy.height.cm = x), type = "resp"), add = T)

##shoot density
plot(wb.depth$zm.veg.density0.0625m2, 1-wb.depth$WD.field.qual.absent,
     xlab = "Density (shoots/0.25x0.25m)",
     ylab = "Probability of disease")

model <- glm(1-WD.field.qual.absent ~ zm.veg.density0.0625m2, family = binomial(link = 'logit'), data = wb.depth)#logistic regression
summary(model)

curve(predict(model, data.frame(zm.veg.density0.0625m2 = x), type = "resp"), add = T)
```

#METHODS COMPARISON
##DATA Organization

```{r}
wb.quad <- wb %>%
    dplyr::select(month.collected, year.collected, depth, quadrat.id, WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low, WD.field.est.absent, WD.field.est.trace, WD.field.est.low, WD.field.est.mid, L1.lesion.no, L2.lesion.no, L3.lesion.no, L4.lesion.no, L1.lesion.area.cm2, L2.lesion.area.cm2, L3.lesion.area.cm2, L4.lesion.area.cm2, L1.area.cm2, L2.area.cm2, L3.area.cm2, L4.area.cm2, no.leaves, L1.OS, L2.OS, L3.OS, L4.OS)
wb.quad$WD.field.qual <- NA
for (n in 1:72) {
  if (wb.quad$WD.field.qual.absent[n] == 1)
  {wb.quad$WD.field.qual[n] = "absent"
  } else if (wb.quad$WD.field.qual.trace[n] == 1) {
    wb.quad$WD.field.qual[n] = "trace"
  } else { wb.quad$WD.field.qual[n] = "low"
    }
}

str(wb.quad)

for (n in 1:72) { #removing lesion area measurements from 3rd leaves that were outside sheath
  if (wb.quad$L3.OS[n] == 1)
    {wb.quad$L3.lesion.area.cm2[n] = NA
  } else {wb.quad$L3.lesion.area.cm2[n] <- wb.quad$L3.lesion.area.cm2[n]}
}

for (n in 1:72) { #removing lesion area measurements from 4th leaves that were outside sheath
  if (wb.quad$L4.OS[n] == 1)
    {wb.quad$L4.lesion.area.cm2[n] = NA
  } else {wb.quad$L4.lesion.area.cm2[n] <- wb.quad$L4.lesion.area.cm2[n]}
}


wb.quad$L1.lpc <- (wb.quad$L1.lesion.area.cm2 / wb.quad$L1.area.cm2)*100
wb.quad$L2.lpc <- (wb.quad$L2.lesion.area.cm2/wb.quad$L2.area.cm2)*100
wb.quad$L3.lpc <- (wb.quad$L3.lesion.area.cm2/wb.quad$L3.area.cm2)*100
wb.quad$L4.lpc <- (wb.quad$L4.lesion.area.cm2/wb.quad$L4.area.cm2)*100

for (n in 1:72) { #excluding lesions less than or equal to 0.1% of leaf as 0 because cannot tell if these are disease related
  if (wb.quad$L1.lpc[n] > 0.1)
  {wb.quad$L1.lpc[n] == wb.quad$L1.lpc[n]}
  else {wb.quad$L1.lpc[n] = 0}
}

for (n in 1:72) { #excluding lesions less than or equal to 0.1% of leaf as 0 because cannot tell if these are disease related
  if (wb.quad$L2.lpc[n] > 0.1)
  {wb.quad$L2.lpc[n] == wb.quad$L2.lpc[n]}
  else {wb.quad$L2.lpc[n] = 0}
}

wb.quad$L3.lpc <- ifelse(wb.quad$L3.lpc > 0.1 | is.na(wb.quad$L3.lpc), wb.quad$L3.lpc, 0)#excluding lesions less than or equal to 0.1% of leaf as 0 because cannot tell if these are disease related

wb.quad$L4.lpc <- ifelse(wb.quad$L4.lpc > 0.1 | is.na(wb.quad$L4.lpc), wb.quad$L4.lpc, 0)#excluding lesions less than or equal to 0.1% of leaf as 0 because cannot tell if these are disease related

#now all lesions less than 0.1 %cover have been excluded, creating a category for oldest leaf within sheath
wb.quad$Llast.lpc <- wb.quad$L4.lpc
wb.quad$Llast.lpc <- ifelse(is.na(wb.quad$Llast.lpc), wb.quad$L3.lpc, wb.quad$Llast.lpc)
wb.quad$Llast.lpc <- ifelse(is.na(wb.quad$Llast.lpc), wb.quad$L2.lpc, wb.quad$Llast.lpc)

#categorical interpretation of Llast lesion % cover
wb.quad$Llast.lpc.cat <- NA
for (n in 1:72) {
  if (wb.quad$Llast.lpc[n] == 0)
  {wb.quad$Llast.lpc.cat[n] = "absent"
  } else if (wb.quad$Llast.lpc[n] > 0 & wb.quad$Llast.lpc[n] < 1) {
    wb.quad$Llast.lpc.cat[n] = "trace"
  } else if (wb.quad$Llast.lpc[n] > 1 & wb.quad$Llast.lpc[n] < 10) {
    wb.quad$Llast.lpc.cat[n] = "low"
  } else if (wb.quad$Llast.lpc[n] > 10 & wb.quad$Llast.lpc[n] < 30) {
    wb.quad$Llast.lpc.cat[n] = "mid"
  } else {wb.quad$Llast.lpc.cat[n] = "high"
    }
}

#only diseased leaves from oldest leaf within sheath (intensity)
wb.quad$Llast.lpc.intensity <- ifelse(wb.quad$Llast.lpc > 0, wb.quad$Llast.lpc, NA)
#Prevelance of disease from oldest leaf within sheath (prevalence)
wb.quad$Llast.present <- ifelse(wb.quad$Llast.lpc > 0, 1, 0)
wb.quad$Llast.absent <- ifelse(wb.quad$Llast.lpc > 0, 0, 1)

#Prevalence of disease from all leaves within a plant (prevalence)
wb.quad$L1.present <- ifelse(wb.quad$L1.lpc > 0, 1, 0)
wb.quad$L2.present <- ifelse(wb.quad$L2.lpc > 0, 1, 0)
wb.quad$L3.present <- ifelse(wb.quad$L3.lpc > 0, 1, 0)
wb.quad$L3.present <- ifelse(is.na(wb.quad$L3.present), 0, wb.quad$L3.present)
wb.quad$L4.present <- ifelse(wb.quad$L4.lpc > 0, 1, 0)
wb.quad$L4.present <- ifelse(is.na(wb.quad$L4.present), 0, wb.quad$L4.present)
wb.quad$L1.absent <- ifelse(wb.quad$L1.lpc > 0, 0, 1)
wb.quad$L2.absent <- ifelse(wb.quad$L2.lpc > 0, 0, 1)
wb.quad$L3.absent <- ifelse(wb.quad$L3.lpc > 0, 0, 1)
wb.quad$L3.absent <- ifelse(is.na(wb.quad$L3.absent), 0, wb.quad$L3.absent)
wb.quad$L4.absent <- ifelse(wb.quad$L4.lpc > 0, 0, 1)
wb.quad$L4.absent <- ifelse(is.na(wb.quad$L4.absent), 0, wb.quad$L4.absent)
wb.quad$leaf.present <- wb.quad$L1.present + wb.quad$L2.present + wb.quad$L3.present + wb.quad$L4.present
wb.quad$leaf.absent <- wb.quad$L1.absent + wb.quad$L2.absent + wb.quad$L3.absent + wb.quad$L4.absent
wb.quad$leaf.present.i <- ifelse(wb.quad$WSWI > 0, wb.quad$leaf.present, NA)
wb.quad$leaf.absent.i <- ifelse(wb.quad$WSWI > 0, wb.quad$leaf.absent, NA)

#editing number of lesion to reflect wasting disease exclusion of less than 0.1%cover
wb.quad$L1.lesion.no <- ifelse(wb.quad$L1.lpc > 0, wb.quad$L1.lesion.no, 0)
wb.quad$L2.lesion.no <- ifelse(wb.quad$L2.lpc > 0, wb.quad$L2.lesion.no, 0)
wb.quad$L3.lesion.no <- ifelse(wb.quad$L3.lpc > 0, wb.quad$L3.lesion.no, 0)
wb.quad$L4.lesion.no <- ifelse(wb.quad$L4.lpc > 0, wb.quad$L4.lesion.no, 0)

#number of lesion from oldest leaf within sheath
wb.quad$Llast.lesion.no <- wb.quad$L4.lesion.no
wb.quad$Llast.lesion.no <- ifelse(is.na(wb.quad$Llast.lesion.no), wb.quad$L3.lesion.no, wb.quad$Llast.lesion.no)
wb.quad$Llast.lesion.no <- ifelse(is.na(wb.quad$Llast.lesion.no), wb.quad$L2.lesion.no, wb.quad$Llast.lesion.no)
wb.quad$Llast.lesion.no <- ifelse(wb.quad$Llast.lesion.no > 0, wb.quad$Llast.lesion.no, NA)

wb.quad$WI <- NA #Wasting index from Burdick et al. 1993
for (n in 1:72) {
  wb.quad$WI[n] = max(wb.quad$L1.lpc[n], wb.quad$L2.lpc[n], wb.quad$L3.lpc[n], wb.quad$L4.lpc[n], na.rm = T)
}

wb.quad$WSWI <- NA #Whole shoot wasting index from Burdick et al. 1993
for (n in 1:72) {
 wb.quad$WSWI[n] = mean(c(wb.quad$L1.lpc[n], wb.quad$L2.lpc[n], wb.quad$L3.lpc[n], wb.quad$L4.lpc[n]), na.rm = T)
}

#Lesion % cover of all leaf tissue
wb.quad$lpc.tissue <- NA
for (n in 1:72) {
  wb.quad$lpc.tissue[n] = (sum(wb.quad$L1.lesion.area.cm2[n], wb.quad$L2.lesion.area.cm2[n], wb.quad$L3.lesion.area.cm2[n], wb.quad$L4.lesion.area.cm2[n], na.rm = T) / sum(wb.quad$L1.area.cm2[n], wb.quad$L2.area.cm2[n], wb.quad$L3.area.cm2[n], wb.quad$L4.area.cm2[n], na.rm = T))*100
}

#editing all leaf tissue % cover to reflect wasting disease exclusion of less than 0.1%cover
wb.quad$lpc.tissue <- ifelse(wb.quad$lpc.tissue > 0.1, wb.quad$lpc.tissue, 0)

#Categorical interpretation of total lesion area %cover
wb.quad$lpc.tissue.cat <- NA
for (n in 1:72) {
  if (wb.quad$lpc.tissue[n] == 0)
  {wb.quad$lpc.tissue.cat[n] = "absent"
  } else if (wb.quad$lpc.tissue[n] > 0 & wb.quad$lpc.tissue[n] < 1) {
    wb.quad$lpc.tissue.cat[n] = "trace"
  } else if (wb.quad$lpc.tissue[n] > 1 & wb.quad$lpc.tissue[n] < 10) {
    wb.quad$lpc.tissue.cat[n] = "low"
  } else if (wb.quad$lpc.tissue[n] > 10 & wb.quad$lpc.tissue[n] < 30) {
    wb.quad$lpc.tissue.cat[n] = "mid"
  } else {wb.quad$lpc.tissue.cat[n] = "high"
    }
}


#mean field targetted leave values
wb.quad$field.est.avg <- (wb.quad$WD.field.est.absent*0 + wb.quad$WD.field.est.trace*1 + wb.quad$WD.field.est.low*2 + wb.quad$WD.field.est.mid*3)/(wb.quad$WD.field.est.absent + wb.quad$WD.field.est.trace + wb.quad$WD.field.est.low + wb.quad$WD.field.est.mid)

wb.quad$field.est.intensity <- (wb.quad$WD.field.est.trace*1 + wb.quad$WD.field.est.low*2 + wb.quad$WD.field.est.mid*3)/(wb.quad$WD.field.est.trace + wb.quad$WD.field.est.low + wb.quad$WD.field.est.mid)

#creating a combined depth*month factor
wb.quad$month.depth <- paste(wb.quad$month.collected, wb.quad$depth, sep = ".")
wb.quad$month.depth <- as.factor(wb.quad$month.depth)

wb.qual.field <- wb.quad %>% #including absents
  dplyr::select(WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low, month.depth) %>%
  group_by(month.depth) %>%
  summarize(absent = sum(WD.field.qual.absent), trace = sum(WD.field.qual.trace), low = sum(WD.field.qual.low))

wb.qual.field.month <- wb.quad %>% #combining absents and traces into one column in order to deal with assumptions of statistical tests
  #and only looking at month
  dplyr::select(WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low, month.collected) %>%
  group_by(month.collected) %>%
  summarize(absent.trace = sum(WD.field.qual.absent, WD.field.qual.trace), low = sum(WD.field.qual.low))

wb.quad$depth.meld <- ifelse(wb.quad$depth == "shallow" | wb.quad$depth == "mid", "shm", "deep")
wb.qual.field.depth <- wb.quad %>% #combining absents and traces into one column in order to deal with assumptions of statistical tests
  #and only looking at shallow.mid vs deep
  dplyr::select(WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low, depth.meld) %>%
  group_by(depth.meld) %>%
  summarize(absent.trace = sum(WD.field.qual.absent, WD.field.qual.trace), low = sum(WD.field.qual.low))

#wb.quad (data set with all metrics are at the quadrat level)
  ##WD.field.qual = Categorical wasting disease lesion percent cover estimate by scuba diver within 0.5x0.5m2 quadrat
  ##L1.lpc-L4.lpc = lesion percent cover {(lesion area - leaf area)/100} of each leaf for each shoot
  ##WI = wasting index sensu Burdick 1993, i.e. lesion percent cover of most diseased leaf of each shoot
  ##WSWI = whole shoot wasting index sensu Burdick 1993, i.e. average of lesion percent cover for all leaves for each shoot
  ##field.est.avg = weighted mean of each category for targeted leaves of 5 shoots/quad from field ,i.e. (#absent*0 + #trace*1 + #low*2 + #mid*3)/(#shoots per quad)

#wb.quad.field (data set for comparison within field metrics)
  ##WD.field.qual = Categorical wasting disease lesion percent cover estimate by scuba diver within 0.5x0.5m2 quadrat
  ##absent, trace, low, mid = The number of shoots (out of the 5 targeted shoots per quadrat that were scored in these lesion percent cover categories)

```

##Field qual vs. wasting index
```{r}
bargraph.CI(x.factor = WD.field.qual,
            response = WSWI,
            data = wb.quad,
            ylim = c(0,20),
            main = "Quad percent cover",
            ylab = "Wasting Index", legend = F)
```

##Field 5-shoot targetted leaf (oldest) vs wasting index
```{r}
plot(WI ~ field.est.avg, data = wb.quad)
```

##Field qual vs. field target (5 shoot)
```{r}
table.wb.quad.field <- matrix(c(2,8,0,0,17,23,17,3,8,18,22,5),ncol=4,byrow=3)
colnames(table.wb.quad.field) <- c("absent","trace","low", "mid")
rownames(table.wb.quad.field) <- c("absent","trace","low")
table.wb.quad.field <- as.table(table.wb.quad.field)
table.wb.quad.field
mosaicplot(table.wb.quad.field, main = "", xlab = "Quad Percent Cover", ylab = "5 Shoot Targetted Leaf % Cover", col = T) 
```

##Wasting Index vs. Whole shoot Wasting Index
```{r}
plot(WI ~ WSWI, data = wb.quad)

#WI vs depth and season 
bargraph.CI(x.factor=depth,response = WI, group = month.collected, data=wb.quad, main= "WI vs. Depth and Season", legend=T)
```

##quad.percent.cover by depth
```{r}
depth.quad<- wb.quad %>%
  dplyr::select(depth, WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low)%>%
  group_by(depth)%>%
  summarize(absent=sum(WD.field.qual.absent), trace=sum(WD.field.qual.trace), low=sum(WD.field.qual.low))
 
  table.wb.depth.quad <- matrix(c(2, 11, 11, 4, 13, 7), ncol = 3, byrow = 2)
  colnames(table.wb.depth.quad) <- c("absent", "trace", "low")
  rownames(table.wb.depth.quad) <- c("deep", "shallow")
  table.wb.depth.quad <- as.table(table.wb.depth.quad)
table.wb.depth.quad



mosaicplot(table.wb.depth.quad, main = "Field Qual vs depth", xlab= "Depth", ylab= "Quad percent cover", col=T) 

```

##Quad percent cover by season
```{r}
season.quad <- wb.quad%>%
  dplyr::select(month.collected,WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low)%>%
  group_by(month.collected)%>%
  summarize(absent=sum(WD.field.qual.absent), trace=sum(WD.field.qual.trace), low=sum(WD.field.qual.low))

table.wb.season.quad <- matrix(c(0, 6, 18, 6, 18, 0), ncol = 3, byrow = 2)
  colnames(table.wb.season.quad) <- c("absent", "trace", "low")
  rownames(table.wb.season.quad) <- c("july", "october")
  table.wb.season.quad <- as.table(table.wb.season.quad)
table.wb.season.quad

mosaicplot(table.wb.season.quad, main = "Month Collected vs Quad Percent Cover", xlab = "Month Collected", ylab = "Quad Percent Cover", col=T)
  
#see if you can add legend
  
```

##WI vs depth x season
```{r}
bargraph.CI(x.factor = depth,
            response = WI,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,10),
            main = "WI vs depth and season",
            ylab = "Wasting Index", legend = T)
```

##WSWI vs depth x season
```{r}
bargraph.CI(x.factor=depth,
            response= WSWI,
            group=month.collected,
            data=wb.quad,
            ylim= c(0,10),
            main= "WSWI cs depth and season",
            ylab= "Whole Shoot Wasting Index", legend= T)
```

##Targeted leaf percent cover vs depth x season
```{r}
bargraph.CI(x.factor=depth,
            response= L3.lpc,
            group=month.collected,
            data=wb.quad,
            ylim= c(0,10),
            main= "3rd Leaf % Cover vs depth and season",
           ylab= "3rd Leaf % Cover", legend= T )
```

##WSWI vs Quad % cover
```{r}
bargraph.CI(x.factor=WD.field.qual,
            response= WSWI,
            data=wb.quad,
            ylim= c(0,10),
            main= "Whole Shoot WI vs. Quad % Cover",
           ylab= "WSWI", legend= T )
```

##WSWI vs 5 shoot (field target)
```{r}
plot(WSWI ~ field.est.avg, data = wb.quad)
```

##3rd leaf % cover vs quad % cover
```{r}
bargraph.CI(x.factor=WD.field.qual,
            response= L3.lpc,
            data=wb.quad,
            ylim= c(0,10),
            main= "3rd leaf % cover vs quad % cover",
           ylab= "3rd leaf % cover", legend= T )
```

##3rd leaf % cover vs 5 shoot
```{r}
plot(L3.lpc ~ field.est.avg, data=wb.quad, main= "3rd leaf % cover vs field estimate ave", ylab= "3rd leaf % cover",
     xlab= "field estimate avg")
```

##3rd leaf % cover vs WI
```{r}
plot(L3.lpc ~ WI, data=wb.quad, main= "3rd leaf % cover vs wasting index", ylab= "3rd leaf % cover",
     xlab= "WI")
```

##3rd leaf % cover vs WSWI
```{r}
plot(L3.lpc ~ WSWI, data=wb.quad, main= "3rd leaf % cover vs whole shoot WI", ylab= "3rd leaf % cover",
     xlab= "WSWI")
```

  

#ALL GRAPHS INCLUDING MID
```{r}
wb.quad2 <- wb %>%
  
  dplyr::select(month.collected, year.collected, depth, quadrat.id, WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low, WD.field.est.absent, WD.field.est.trace, WD.field.est.low, WD.field.est.mid, L1.lesion.area.cm2, L2.lesion.area.cm2, L3.lesion.area.cm2, L4.lesion.area.cm2, L1.area.cm2, L2.area.cm2, L3.area.cm2, L4.area.cm2, no.leaves, L1.OS, L2.OS, L3.OS, L4.OS)

wb.quad2$WD.field.qual <- NA
for (n in 1:72) {
  if (wb.quad2$WD.field.qual.absent[n] == 1)
  {wb.quad2$WD.field.qual[n] = "absent"
  } else if (wb.quad2$WD.field.qual.trace[n] == 1) {
    wb.quad2$WD.field.qual[n] = "trace"
  } else { wb.quad2$WD.field.qual[n] = "low"
    }
}
wb.quad2$WD.field.qual <- as.factor(wb.quad2$WD.field.qual)

str(wb.quad2)

wb.quad2$L1.lpc <- (wb.quad2$L1.lesion.area.cm2 / wb.quad2$L1.area.cm2)*100
wb.quad2$L2.lpc <- (wb.quad2$L2.lesion.area.cm2/wb.quad2$L2.area.cm2)*100
wb.quad2$L3.lpc <- (wb.quad2$L3.lesion.area.cm2/wb.quad2$L3.area.cm2)*100
wb.quad2$L4.lpc <- (wb.quad2$L4.lesion.area.cm2/wb.quad2$L4.area.cm2)*100

wb.quad2$WI <- NA
for (n in 1:72) {
  wb.quad2$WI[n] = max(wb.quad2$L1.lpc[n], wb.quad2$L2.lpc[n], wb.quad2$L3.lpc[n], wb.quad2$L4.lpc[n], na.rm = T)
}

wb.quad2$WSWI <- NA
for (n in 1:72) {
 wb.quad2$WSWI[n] = sum(wb.quad2$L1.lpc[n], wb.quad2$L2.lpc[n], wb.quad2$L3.lpc[n], wb.quad2$L4.lpc[n], na.rm = T) / wb.quad2$no.leaves[n]
}

wb.quad2$field.est.avg <- (wb.quad2$WD.field.est.absent*0 + wb.quad2$WD.field.est.trace*1 + wb.quad2$WD.field.est.low*2 + wb.quad2$WD.field.est.mid*3)/(wb.quad2$WD.field.est.absent + wb.quad2$WD.field.est.trace + wb.quad2$WD.field.est.low + wb.quad2$WD.field.est.mid)

wb.quad.field2 <- wb.quad2 %>%
  dplyr::select(WD.field.est.absent, WD.field.est.trace, WD.field.est.low, WD.field.est.mid, WD.field.qual) %>%
  filter(WD.field.est.absent != "NA") %>%
  group_by(WD.field.qual) %>%
  summarize(absent = sum(WD.field.est.absent), trace = sum(WD.field.est.trace), low = sum(WD.field.est.low), mid = sum(WD.field.est.mid))

wb.OS <- wb.quad2 %>%
  dplyr:: select(L4.OS, L3.OS, L2.OS, L1.OS, WD.field.est.trace, WD.field.est.low,WD.field.est.mid, WD.field.est.absent, WD.field.qual)%>%
  filter(L4.OS != "NA") %>% 
  filter(L3.OS  != "NA") %>%
  filter(L2.OS != "NA") %>% 
  filter(L1.OS !="NA") %>%
filter(WD.field.est.absent != "NA") %>%
  group_by(L4.OS) %>%
  summarize(absent = sum(WD.field.est.absent), trace = sum(WD.field.est.trace), low = sum(WD.field.est.low), mid = sum(WD.field.est.mid))
  

#wb.quad (data set with all metrics are at the quadrat level)
  ##WD.field.qual = Categorical wasting disease lesion percent cover estimate by scuba diver within 0.5x0.5m2 quadrat
  ##L1.lpc-L4.lpc = lesion percent cover {(lesion area - leaf area)/100} of each leaf for each shoot
  ##WI = wasting index sensu Burdick 1993, i.e. lesion percent cover of most diseased leaf of each shoot
  ##WSWI = whole shoot wasting index sensu Burdick 1993, i.e. average of lesion percent cover for all leaves for each shoot
  ##field.est.avg = weighted mean of each category for targeted leaves of 5 shoots/quad from field ,i.e. (#absent*0 + #trace*1 + #low*2 + #mid*3)/(#shoots per quad)

#wb.quad.field (data set for comparison within field metrics)
  ##WD.field.qual = Categorical wasting disease lesion percent cover estimate by scuba diver within 0.5x0.5m2 quadrat
  ##absent, trace, low, mid = The number of shoots (out of the 5 targeted shoots per quadrat that were scored in these lesion percent cover categories)
#wb.OS (formatting outside sheath to exclude NAs)
```

##Field qual vs. whole shoot wasting index
```{r}
bargraph.CI(x.factor = WD.field.qual,
            response = WSWI,
            data = wb.quad2,
            ylim = c(0,50),
            main = "WSWI vs Quad percent cover",
            ylab = "Whole Shoot Wasting Index", legend = F)


```

##Field 5-shoot targetted leaf (oldest) vs wasting index
```{r}
plot(WI ~ field.est.avg, data = wb.quad2)
```

##Field qual vs. field target (5 shoot)
```{r}
#from wb.quad.field2 data frame 
table.wb.quad.field <- matrix(c(2,8,0,0,11,24,28,5,20,30,20,5),ncol=4,byrow=3)
colnames(table.wb.quad.field) <- c("absent","trace","low", "mid")
rownames(table.wb.quad.field) <- c("absent","trace","low")
table.wb.quad.field <- as.table(table.wb.quad.field)
table.wb.quad.field
mosaicplot(table.wb.quad.field, main = "", xlab = "Quad Percent Cover", ylab = "5 Shoot Targetted Leaf % Cover", col = T)
```

##Wasting Index vs. Whole shoot Wasting Index
```{r}
plot(WI ~ WSWI, data = wb.quad2)

#WI vs depth and season 
bargraph.CI(x.factor=depth, response = WI, group = month.collected, data=wb.quad2, main= "WI vs. Depth and Season", legend=T)
```

##quad.percent.cover by depth
```{r}
depth.quad2<- wb.quad2 %>%
  dplyr::select(depth, WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low)%>%
  group_by(depth)%>%
  summarize(absent=sum(WD.field.qual.absent), trace=sum(WD.field.qual.trace), low=sum(WD.field.qual.low))
 
  table.wb.depth.quad <- matrix(c(2, 11, 11, 3, 14, 7, 4, 13, 7), ncol = 3, byrow = 3)
  colnames(table.wb.depth.quad) <- c("absent", "trace", "low")
  rownames(table.wb.depth.quad) <- c("deep", "shallow", "mid")
  table.wb.depth.quad <- as.table(table.wb.depth.quad)
table.wb.depth.quad



mosaicplot(table.wb.depth.quad, main = "Field Qual vs depth", xlab= "Depth", ylab= "Quad percent cover", col=T) 

```

##Quad percent cover by season
```{r}
season.quad2 <- wb.quad2%>%
  dplyr::select(month.collected,WD.field.qual.absent, WD.field.qual.trace, WD.field.qual.low)%>%
  group_by(month.collected)%>%
  summarize(absent=sum(WD.field.qual.absent), trace=sum(WD.field.qual.trace), low=sum(WD.field.qual.low))

table.wb.season.quad <- matrix(c(0, 11, 25, 9, 27, 0), ncol = 3, byrow = 2)
  colnames(table.wb.season.quad) <- c("absent", "trace", "low")
  rownames(table.wb.season.quad) <- c("july", "october")
  table.wb.season.quad <- as.table(table.wb.season.quad)
table.wb.season.quad

mosaicplot(table.wb.season.quad, main = "Month Collected vs Quad Percent Cover", xlab = "Month Collected", ylab = "Quad Percent Cover", col=T)
  
#see if you can add legend
  
```

##WI vs depth x season
```{r}
bargraph.CI(x.factor = depth,
            response = WI,
            group = month.collected,
            data = wb.quad2,
            ylim = c(0,20),
            main = "WI vs depth and season",
            ylab = "Wasting Index", legend = T)
```

##WSWI vs depth x season
```{r}
bargraph.CI(x.factor=depth,
            response= WSWI,
            group=month.collected,
            data=wb.quad2,
            ylim= c(0,10),
            main= "WSWI vs depth and season",
            ylab= "Whole Shoot Wasting Index", legend= T)
```

##Targeted leaf percent cover vs depth x season
```{r}
bargraph.CI(x.factor=depth,
            response= L3.lpc,
            group= month.collected,
            data= wb.quad2,
            ylim= c(0,10),
            main= "3rd Leaf % Cover vs depth and season",
           ylab= "3rd Leaf % Cover", legend= T )
```

##WSWI vs Quad % cover
```{r}
bargraph.CI(x.factor=WD.field.qual,
            response= WSWI,
            data=wb.quad2,
            ylim= c(0,10),
            main= "Whole Shoot WI vs. Quad % Cover",
           ylab= "WSWI", legend= T )
```

##WSWI vs 5 shoot (field target)
```{r}
plot(WSWI ~ field.est.avg, data = wb.quad2)
```

##3rd leaf % cover vs quad % cover
```{r}
bargraph.CI(x.factor=WD.field.qual,
            response= L3.lpc,
            data=wb.quad2,
            ylim= c(0,10),
            main= "3rd leaf % cover vs quad % cover",
           ylab= "3rd leaf % cover", legend= T )
```

##3rd leaf % cover vs 5 shoot
```{r}
plot(L3.lpc ~ field.est.avg, data=wb.quad2, main= "3rd leaf % cover vs field estimate ave", ylab= "3rd leaf % cover",
     xlab= "field estimate avg")
```

##3rd leaf % cover vs WI
```{r}
plot(L3.lpc ~ WI, data=wb.quad2, main= "3rd leaf % cover vs wasting index", ylab= "3rd leaf % cover",
     xlab= "WI")
```

##3rd leaf % cover vs WSWI
```{r}
plot(L3.lpc ~ WSWI, data=wb.quad2, main= "3rd leaf % cover vs whole shoot WI", ylab= "3rd leaf % cover",
     xlab= "WSWI")
```

##L4 OS vs WI
```{r}
bargraph.CI(x.factor=L4.OS,
            response= WI,
            data= wb.quad2,
            ylim= c(0,50),
            main= "October Wasting Index and 4th Leaf OS",
            xlab= "Leaf 4 Outside Sheath",
            ylab= "Wasting Index",
             legend= T )
```

##L3 OS vs WI
```{r}
bargraph.CI(x.factor=L3.OS,
            response= WI,
            data= wb.quad2,
            ylim= c(0,50),
            main= "October Wasting Index and 3rd Leaf OS",
            xlab= "Leaf 3 Outside Sheath",
            ylab= "Wasting Index",
             legend= T )
```

##L4 OS vs WSWI
```{r}
bargraph.CI(x.factor=L4.OS,
            response= WSWI,
            data= wb.quad2,
            ylim= c(0,50),
            main= "October Whole Shoot WI and 4th Leaf OS",
            xlab= "Leaf 4 Outside Sheath",
            ylab= "Whole Shoot Wasting Index",
             legend= T )
```

##L3 OS vs WSWI
```{r}
bargraph.CI(x.factor=L4.OS,
            response= WSWI,
            data= wb.quad2,
            ylim= c(0,50),
            main= "October Whole Shoot WI and 4th Leaf OS",
            xlab= "Leaf 4 Outside Sheath",
            ylab= "Whole Shoot Wasting Index",
             legend= T )
```

##L4 OS vs field est avg
```{r}
bargraph.CI(x.factor=L4.OS,
            response= field.est.avg,
            data= wb.quad2,
            ylim= c(0,10),
            main= "October 5 shoot estimate and 4th Leaf OS",
            xlab= "Leaf 4 Outside Sheath",
            ylab= "Field estimate average",
             legend= T )
```

##L3 OS vs field est avg
```{r}
bargraph.CI(x.factor=L4.OS,
            response= field.est.avg,
            data= wb.quad2,
            ylim= c(0,10),
            main= "October 5 Shoot Estimate and 3rd Leaf OS",
            xlab= "Leaf 4 Outside Sheath",
            ylab= "Field estimate average",
             legend= T )
```

##L4 OS vs quad % cover
```{r}
 table.OS.quad <- matrix(c( 1, 6, 3, 0, 5, 5, 4, 1), ncol = 4, byrow = 2)
   colnames(table.OS.quad) <- c("absent", "trace", "low", "mid")
   rownames(table.OS.quad) <- c("no", "yes")
    table.OS.quad <- as.table(table.OS.quad)
            table.OS.quad

mosaicplot(table.OS.quad, main = "October: 4th Leaf Outside Shoot and Quad Percent Cover", xlab = "4th Leaf Outside Sheath", ylab = "Quad Percent Cover", col=T)

```



#Forest Figures/analyses
## Quadrat mean percent cover analyses
```{r}
#Season
tab.season <- matrix(data = c(11,36,25,0), nrow = 2, ncol = 2)
rownames(tab.season) <- c("july", "october")
colnames(tab.season) <- c("trace", "low")
fisher.test(tab.season) #lesion severity is lower in fall than in summer

#depth
tab.depth <- matrix(data = c(13, 34, 11, 14), nrow = 2, ncol = 2)
rownames(tab.depth) <- c("deep", "shm")
colnames(tab.depth) <- c("trace", "low")
fisher.test(tab.depth) #lesion severity does not differ between deep transect and shallow/mid transects

```

##NMDS Quadrat mean percent cover
```{r}
wb.transect <- wb.quad %>%
  group_by(month.collected, depth) %>%
  summarize(WD.field.qual.absent = sum(WD.field.qual.absent), WD.field.qual.trace = sum(WD.field.qual.trace), WD.field.qual.low = sum(WD.field.qual.low))

wb.transect$qual.absent.prop <- wb.transect$WD.field.qual.absent / (wb.transect$WD.field.qual.absent + wb.transect$WD.field.qual.trace + wb.transect$WD.field.qual.low)

wb.transect$qual.trace.prop <- wb.transect$WD.field.qual.trace / (wb.transect$WD.field.qual.absent + wb.transect$WD.field.qual.trace + wb.transect$WD.field.qual.low)

wb.transect$qual.low.prop <- wb.transect$WD.field.qual.low / (wb.transect$WD.field.qual.absent + wb.transect$WD.field.qual.trace + wb.transect$WD.field.qual.low)
  
community <- subset(wb.transect, select = c("qual.absent.prop",
                                        "qual.trace.prop",
                                        "qual.low.prop"))
## --- nMDS Analysis/figures ---
set.seed(1)

# Hellinger transformation to downplay the effects of rare species
# community.trans <- decostand(community, "hell")

comm.mds <- metaMDS(community, autotransform = FALSE) ##nMDS analysis code

# Rsquared
(Rsq <- 1 - comm.mds$stress^2) #high Rsquared means that axis explain most of variation in data

# Extract transect scores from nMDS object to facilitate custom plot
quad.scores <- comm.mds$points

# Extract disease severity category scores (commonly species scores)
severity.scores <- comm.mds$species

# Relabel severity scores
rownames(severity.scores) <- c("absent", 
                              "trace", "low")

mycols.month <- cb[c("blue", "red")] ##setting up vector to color points by depth, data set won't ignore third depth so added extra for 'ghost' mid depth)

## Prepare an empty plot
#pdf(file="nmds_meanMaxTemp.pdf", width=8, height=8)
par(plotconf)
plot(comm.mds$points[ , 1], comm.mds$points[ , 2], t = "n", 
     xlab = "nMDS 1", ylab = "",
     main= "",
     xlim = c(-1.25, 1.25), 
     xaxs = "i",
     ylim = c(-1, 1))
# Add y-axis label
ylabel("nMDS 2")
# Add top and right axes
mbox()
## Draw grid with dashed lines about origin
abline(h = 0, lty = 2)
abline(v = 0, lty = 2)
add_label(x = 0.78, lab = substitute(paste(R^2 == rsq),
                                     list(rsq = format(Rsq, digit = 5))))

# Plot each region's site scores in a different color and shape
points(jitter(quad.scores[1:3,]), pch = 21, bg = mycols.month[1], col = mycols.month[1], cex = 2)
points(quad.scores[4:6,], pch = 22, bg = mycols.month[2], col = mycols.month[2], cex = 2)

month.names <- c("July", "October")
legend(x = "topleft", legend = month.names, pch = (1:2) + 20, 
       col = mycols.month, 
       pt.bg = mycols.month,
       cex = 2)
text(severity.scores, c("Absent", "Trace", "Low"), col = cb["pink"], cex = 2)

regions <- wb.transect$month.collected
#regions2 <- wb$depth

expl.all <- subset(wb.transect, select = c("month.collected"))

#env <- subset(wb.transect, select = c("month.collected"))

expl.fit <- envfit(comm.mds, expl.all, permu = 999, na.rm = TRUE)
#env.fit <- envfit(comm.mds, env, permu = 999, na.rm = TRUE)
#biotic.fit <- envfit(comm.mds, biotic, permu = 999, na.rm = TRUE)
expl.fit
#env.fit
#biotic.fit

rownames(expl.fit$factors$centroids) <- c("July", "October" , "" , "")
#rownames(expl.fit$vectors$arrows) <- c("Density", "Length")

expl.fit2 <- expl.fit
#expl.fit2$vectors <- NULL

# Plot 95% CI ellipses
plot(expl.fit2, p.max = 0.2, col = cb["black"])
pl <- ordiellipse(comm.mds, regions, kind = "se", conf = 0.95, lwd = 2, 
                  draw = "poly", col = cb["grey"], alpha = 40, label = FALSE)

```


##prevalence- Oldest leaf in sheath
```{r}
bargraph.CI(x.factor = depth,
            response = Llast.present,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,1.1),
            main = "scan oldest leaf in sheath Prevalence",
            ylab = "proportion of shoots infected", legend = T)

model <- glm(cbind(Llast.present, Llast.absent) ~ month.collected*depth, na.action = na.omit, data = wb.quad, family = binomial)
anova(model, test = "LR") #no significant effects
```

##intensity- Oldest leaf in sheath
```{r}
wb.quad$logit.Llast.lpc.intensity <- ifelse(wb.quad$Llast.lpc.intensity > 0, log((wb.quad$Llast.lpc.intensity/100)/(1-(wb.quad$Llast.lpc.intensity/100))), NA)

bargraph.CI(x.factor = depth,
            response = Llast.lpc.intensity,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,10),
            main = "scan oldest leaf in sheath intensity",
            ylab = "Lesion percent cover", legend = T)

model <- aov(logit.Llast.lpc.intensity ~ month.collected*depth, data = wb.quad)
anova(model) #no significant effects
shapiro.test(model$residuals) #fails even with transformation
hist(wb.quad$Llast.lpc.intensity)

kruskal.test(Llast.lpc.intensity ~ month.depth, data = wb.quad) #not significant (neither are depth or month.collected alone)

```

##Categorical intensity Oldest leaf in sheath
```{r}
#Season
tab.season <- matrix(data = c(9,15,18,14), nrow = 2, ncol = 2)
rownames(tab.season) <- c("july", "october")
colnames(tab.season) <- c("trace", "low/mid")
fisher.test(tab.season) #Not significant
chisq.test(tab.season) #Not significant

table.Llast.lps.cat.season<- matrix(c(9,15,3,15,14,0), ncol = 3, byrow = 2)
  colnames(table.Llast.lps.cat.season) <- c("trace", "low", "mid")
  rownames(table.Llast.lps.cat.season) <- c("july", "october")
  table.Llast.lps.cat.season <- as.table(table.Llast.lps.cat.season)
table.Llast.lps.cat.season

mosaicplot(table.Llast.lps.cat.season, main = "Month Collected vs Oldest Leaf in Sheath Lesion Percent Cover", xlab = "Month Collected", ylab = "Lesion Percent Cover", col=c("grey80", "grey50", "grey20"))
```

##NMDS Categorical severity of oldest leaf in sheath
```{r}
Llast.lpc.cat <- read.csv("Llast.lps.cat.csv", header = T)

str(Llast.lpc.cat)

Llast.lpc.cat$month.depth <- paste(Llast.lpc.cat$season, Llast.lpc.cat$depth, sep = ".")

Llast.lpc.cat$month.depth <- as.factor(Llast.lpc.cat$month.depth)

community <- subset(Llast.lpc.cat, select = c("prop.absent",
                                              "prop.trace",
                                              "prop.low",
                                              "prop.mid"))
## --- nMDS Analysis/figures ---
set.seed(1)

# Hellinger transformation to downplay the effects of rare species
# community.trans <- decostand(community, "hell")

comm.mds <- metaMDS(community, autotransform = FALSE) ##nMDS analysis code

# Rsquared
(Rsq <- 1 - comm.mds$stress^2) #high Rsquared means that axis explain most of variation in data

# Extract transect scores from nMDS object to facilitate custom plot
quad.scores <- comm.mds$points

# Extract disease severity category scores (commonly species scores)
severity.scores <- comm.mds$species

# Relabel severity scores
rownames(severity.scores) <- c("Absent","Trace", 
                              "Low", "Mid")

mycols.month <- cb[c("blue", "red")] ##setting up vector to color points by depth, data set won't ignore third depth so added extra for 'ghost' mid depth)

## Prepare an empty plot
#pdf(file="nmds_meanMaxTemp.pdf", width=8, height=8)
par(plotconf)
plot(comm.mds$points[ , 1], comm.mds$points[ , 2], t = "n", 
     xlab = "nMDS 1", ylab = "",
     main= "",
     xlim = c(-1.25, 1.25), 
     xaxs = "i",
     ylim = c(-1, 1))
# Add y-axis label
ylabel("nMDS 2")
# Add top and right axes
mbox()
## Draw grid with dashed lines about origin
abline(h = 0, lty = 2)
abline(v = 0, lty = 2)
#add_label(x = 0.78, lab = substitute(paste(R^2 == rsq),
                                     #list(rsq = format(Rsq, digit = 5))))

# Plot each region's site scores in a different color and shape
points(quad.scores[1:3,], pch = 21, bg = mycols.month[1], col = mycols.month[1], cex = 2)
points(quad.scores[4:6,], pch = 22, bg = mycols.month[2], col = mycols.month[2], cex = 2)

month.names <- c("July", "October")
legend(x = "topright", legend = month.names, pch = (1:2) + 20, 
       col = mycols.month, 
       pt.bg = mycols.month, cex = 2)
text(severity.scores, rownames(severity.scores), col = cb["pink"], cex = 2)

regions <- Llast.lpc.cat$season
#regions2 <- wb$depth

expl.all <- subset(Llast.lpc.cat, select = c("season"))

#env <- subset(Llast.lpc.cat, select = c("season"))

expl.fit <- envfit(comm.mds, expl.all, permu = 500, na.rm = TRUE)
#env.fit <- envfit(comm.mds, env, permu = 999, na.rm = TRUE)
#biotic.fit <- envfit(comm.mds, biotic, permu = 999, na.rm = TRUE)
expl.fit
#env.fit
#biotic.fit

rownames(expl.fit$factors$centroids) <- c("July", "October")
#rownames(expl.fit$vectors$arrows) <- c("Density", "Length")

expl.fit2 <- expl.fit
#expl.fit2$vectors <- NULL

# Plot 95% CI ellipses
plot(expl.fit2, p.max = 0.2, col = cb["black"])
pl <- ordiellipse(comm.mds, regions, kind = "se", conf = 0.95, lwd = 2, 
                  draw = "poly", col = mycols.month, alpha = 40, label = FALSE,)



```

##NMDS Categorical severity of all leaves in sheath
```{r}
Lall.lpc.cat <- read.csv("Lall.lps.cat.csv", header = T)

str(Lall.lpc.cat)

Lall.lpc.cat$month.depth <- paste(Lall.lpc.cat$season, Lall.lpc.cat$depth, sep = ".")

Lall.lpc.cat$month.depth <- as.factor(Lall.lpc.cat$month.depth)

community <- subset(Lall.lpc.cat, select = c("prop.absent",
                                              "prop.trace",
                                              "prop.low",
                                              "prop.mid"))
## --- nMDS Analysis/figures ---
set.seed(1)

# Hellinger transformation to downplay the effects of rare species
# community.trans <- decostand(community, "hell")

comm.mds <- metaMDS(community, autotransform = FALSE) ##nMDS analysis code

# Rsquared
(Rsq <- 1 - comm.mds$stress^2) #high Rsquared means that axis explain most of variation in data

# Extract transect scores from nMDS object to facilitate custom plot
quad.scores <- comm.mds$points

# Extract disease severity category scores (commonly species scores)
severity.scores <- comm.mds$species

# Relabel severity scores
rownames(severity.scores) <- c("Absent","Trace", 
                              "Low", "Mid")

mycols.month <- cb[c("blue", "red")] ##setting up vector to color points by depth, data set won't ignore third depth so added extra for 'ghost' mid depth)

## Prepare an empty plot
#pdf(file="nmds_meanMaxTemp.pdf", width=8, height=8)
par(plotconf)
plot(comm.mds$points[ , 1], comm.mds$points[ , 2], t = "n", 
     xlab = "nMDS 1", ylab = "",
     main= "",
     xlim = c(-1.25, 1.25), 
     xaxs = "i",
     ylim = c(-1, 1))
# Add y-axis label
ylabel("nMDS 2")
# Add top and right axes
mbox()
## Draw grid with dashed lines about origin
abline(h = 0, lty = 2)
abline(v = 0, lty = 2)
add_label(x = 0.78, lab = substitute(paste(R^2 == rsq),
                                     list(rsq = format(Rsq, digit = 5))))

# Plot each region's site scores in a different color and shape
points(quad.scores[1:3,], pch = 21, bg = mycols.month[1], col = mycols.month[1], cex = 2.5)
points(quad.scores[4:6,], pch = 22, bg = mycols.month[2], col = mycols.month[2], cex = 2)

month.names <- c("July", "October")
legend(x = "topright", legend = month.names, pch = (1:2) + 20, 
       col = mycols.month, 
       pt.bg = mycols.month, cex = 2)
text(severity.scores, rownames(severity.scores), col = cb["pink"], cex = 2)

regions <- Llast.lpc.cat$season
#regions2 <- wb$depth

expl.all <- subset(Llast.lpc.cat, select = c("season"))

#env <- subset(Llast.lpc.cat, select = c("season"))

expl.fit <- envfit(comm.mds, expl.all, permu = 700, na.rm = TRUE)
#env.fit <- envfit(comm.mds, env, permu = 999, na.rm = TRUE)
#biotic.fit <- envfit(comm.mds, biotic, permu = 999, na.rm = TRUE)
expl.fit
#env.fit
#biotic.fit

rownames(expl.fit$factors$centroids) <- c("July", "October")
#rownames(expl.fit$vectors$arrows) <- c("Density", "Length")

expl.fit2 <- expl.fit
#expl.fit2$vectors <- NULL

# Plot 95% CI ellipses
plot(expl.fit2, p.max = 0.2, col = cb["black"])
pl <- ordiellipse(comm.mds, regions, kind = "se", conf = 0.95, lwd = 2, 
                  draw = "poly", col = cb["grey"], alpha = 40, label = FALSE)



```

##intensity- avg 5 shoot from field
```{r}
bargraph.CI(x.factor = depth,
            response = field.est.intensity,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,3),
            main = "Field oldest leaf in sheath intensity",
            ylab = "Relative lesion percent cover", legend = T)

model <- aov(field.est.intensity ~ month.collected*depth, data = wb.quad)
anova(model)
```

##Lesion number on infected shoots from scans
```{r}
bargraph.CI(x.factor = depth,
            response = Llast.lesion.no,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,20),
            main = "Scan oldest leaf in sheath lesion number in infected leaves",
            ylab = "Lesion number per leaf", legend = T)

model <- aov(Llast.lesion.no ~ month.collected*depth, data = wb.quad)
anova(model) #no siginificant effects
shapiro.test(model$residuals) #passed
leveneTest(model) #passed
```

##Average Lesion size
```{r}
wb.quad$avg.lesion.pc <- wb.quad$Llast.lpc.intensity/wb.quad$Llast.lesion.no
wb.quad$logit.avg.lesion.pc <- ifelse(wb.quad$avg.lesion.pc > 0, log((wb.quad$avg.lesion.pc/100)/(1-(wb.quad$avg.lesion.pc/100))), NA)

bargraph.CI(x.factor = depth,
            response = avg.lesion.pc,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,1.5),
            main = "Scan oldest leaf in sheath avg lesion percent cover in infected leaves",
            ylab = "Mean lesion percent cover", legend = T)

model <- aov(logit.avg.lesion.pc ~ month.collected*depth, data = wb.quad)
anova(model) #no significant effects
shapiro.test(model$residuals) #passed with logit transformation
leveneTest(model) #passed
```

##Wasting index (Burdick 1993)
```{r}
wb.quad$logit.WI <- ifelse(wb.quad$WI > 0, log((wb.quad$WI/100)/(1-(wb.quad$WI/100))), NA) #excludes shoots without disease

bargraph.CI(x.factor = depth,
            response = WI,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,10),
            main = "",
            ylab = "Wasting Index", legend = T)

model <- aov(logit.WI ~ month.collected*depth, data = wb.quad)
anova(model) #no significant effects
shapiro.test(model$residuals) #passed
plot(model) 
hist(model$residuals)

hist(asin(sqrt(wb.quad$WI/100)))
```

##Whole Shoot Wasting index (Burdick 1993)
```{r}

wb.quad$logit.WSWI <- ifelse(wb.quad$WSWI > 0, log((wb.quad$WSWI/100)/(1-(wb.quad$WSWI/100))), NA) #excludes shoots without disease

bargraph.CI(x.factor = depth,
            response = WSWI,
            group = month.collected,
            data = wb.quad,
            ylim = c(0,5),
            main = "",
            ylab = "Whole Shoot Wasting Index", legend = T)

model <- aov(logit.WSWI ~ month.collected*depth, data = wb.quad)
anova(model) #no significant effects
shapiro.test(model$residuals) #passed
plot(model)
hist(model$residuals)

hist(asin(sqrt(wb.quad$WI/100)))
```

##Number of leaves
```{r}
wb$no.leaves.edit <- wb$no.leaves - (wb$L2.OS + wb$L3.OS + wb$L4.OS)

model <- aov(no.leaves.edit ~ month.collected*depth, data = wb)
anova(model) #marginal interaction
shapiro.test(model$residuals) #fail without transformation
hist(model$residuals)

bargraph.CI(x.factor = depth,
            response = no.leaves.edit,
            group = month.collected,
            data = wb,
            ylim = c(0,5),
            ylab = "number of leaves", legend = T)
```

##Prevalence Leaf (all)
```{r}
bargraph.CI(x.factor = month.collected,
            response = leaf.present/(leaf.present+leaf.absent),
            #group = month.collected,
            data = wb.quad,
            ylim = c(0,1.1),
            main = "scan all leaves in sheath Prevalence",
            ylab = "Proportion of leaves infected", legend = T)

model <- glm(cbind(leaf.present, leaf.absent) ~ month.collected*depth, na.action = na.omit, data = wb.quad, family = binomial)
anova(model, test = "LR") #significant effect of season

bargraph.CI(x.factor = month.collected,
            response = leaf.present.i/(leaf.present.i+leaf.absent.i),
            #group = month.collected,
            data = wb.quad,
            ylim = c(0,1.1),
            col = c(cb["blue"], cb["red"]))
            #main = "scan all leaves in sheath Prevalence (only of infected shoots)",
            #ylab = "Proportion of leaves infected on infected shoots", legend = T)

model <- glm(cbind(leaf.present.i, leaf.absent.i) ~ month.collected*depth, na.action = na.omit, data = filter(wb.quad, depth != "mid"), family = binomial)
anova(model, test = "LR") #significant effect of month collected, fewer infected in July than in October


bargraph.CI(x.factor = month.collected,
            response = leaf.absent.i,
            #group = depth,
            data = wb.quad,
            ylim = c(0,3),
            #main = "scan number of healthy leaves in sheath (only of infected shoots)",
            #ylab = "Number of healthy leaves in sheath of infected shoots", legend = T)
            col = c(cb["blue"], cb["red"]))
model <- aov(leaf.absent.i ~ month.collected*depth, data = filter(wb.quad, depth != "mid"))
anova(model)

```

#TEMPERATURE DATA
```{r}
wb_temp <- read.csv("WB_tempdata_14-17.csv", header = T) #uploading data
str(wb_temp)

#formating datetimestamp
wb_temp$datetimestamp <- ymd_hms(wb_temp$datetimestamp)
class(wb_temp$datetimestamp)
tz(wb_temp$datetimestamp) #check what time zone are we in
wb_temp$datetimestamp <- ymd_hms(wb_temp$datetimestamp, tz = "America/Jamaica") #Setting class as posix = good for date time stamps and also setting time zone
class(wb_temp$datetimestamp)
tz(wb_temp$datetimestamp) 

wb_temp <- wb_temp %>% 
  mutate(
    mo = month(datetimestamp, label = TRUE))

head(wb_temp)

focal.months <- wb_temp %>%
  filter(month == 7 | month == 10)
focal.months$temp.C <- ifelse(focal.months$mo == "Jul" & focal.months$year == "2017", NA, focal.months$temp.C)

#Full time series
ggplot(wb_temp, aes(x = datetimestamp, y = temp.C, colour = transect)) + 
  geom_line()

bargraph.CI(x.factor = mo,
            response = temp.C,
            group = transect,
            data = wb_temp,
            ylim = c(0,20),
            legend = T)

#Only July and October
ggplot(focal.months, aes(x = datetimestamp, y = temp.C, colour = transect)) + 
  geom_line()

ggplot(focal.months, aes(x = mo, y = temp.C)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Temperature C", breaks = seq(0,25, 5), limits = c(0,25)) +
  #scale_x_discrete(name = "Month") +
  facet_grid(.~ transect)

bargraph.CI(x.factor = mo,
            response = temp.C.mean,
            group = transect,
            data = focal.months.sum,
            ylim = c(10,18),
            legend = T)

focal.months.sum <- focal.months %>%
  group_by(year, mo, transect) %>%
  summarize(temp.C.mean = mean(temp.C, na.rm = T), temp.C.max = max(temp.C, na.rm = T), temp.C.min = min(temp.C, na.rm = T), temp.C.var = var(temp.C, na.rm = T))

#mean monthly temp
model <- aov(temp.C.mean ~ year*transect*mo, data = focal.months.sum)
anova(model)

#montly temp
model <- aov(temp.C ~ year*transect*mo, data = focal.months)
anova(model)
model <-aov(temp.C ~ transect*mo, data = focal.months)
anova(model)
posthoc <- TukeyHSD(x=model, 'transect:mo', conf.level=0.95)
posthoc


```

#MAP
```{r}
setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/State Boundaries/MA Boundary")
ogrInfo(".", "GISDATA_OUTLINE25K_ARC")
MA.boundary <- readOGR(dsn = ".", layer = "GISDATA_OUTLINE25K_ARC")   #layer of MA State boundary

setwd("~/Dropbox/EEMB Graduate/Research/ZosteraWastingDisease/Greenhouse_Mesocosm/Innoculation Trials/Trial_2/NE_seagrass_habitat/MassDEP Seagrass (1995 and 2001)")
ogrInfo(".", "GISDATA_EELGRASS_POLY")
zm.95.01 <- readOGR(dsn = ".", layer = "GISDATA_EELGRASS_POLY")   #layer of seagrass habitat MA

map("worldHires", "usa", xlim = c(-71.2,-70.45), ylim = c(42.2, 42.72), col = "white", fill = FALSE)
plot(MA.boundary, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "grey80")
plot(zm.95.01, add = TRUE, xlim = c(-71.2,-70.45), ylim = c(42.2, 42.65), col = "darkgreen", border = FALSE)
points(-70.80609, 42.55913, pch = 19, col = "Red", cex = 2)
points(-71.056443, 42.357611, pch = 18, col = "Black", cex = 2)
#text(-71.02, 42.335, "EPA Offices, Boston, MA")
points(-70.907348, 42.418700, pch = 18, col = "Black", cex = 2)
#text(-71.02, 42.335, "Marine Science Center, Nahant, MA")
points(-70.676975, 42.615447, pch = 18, col = "Black", cex = 2)
map.scale(-70.637, 42.25, ratio = FALSE)
box(col = "darkblue", lwd = "3")
```

